apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: api
spec:
  replicas: 3
  workloadRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api
  strategy:
    canary:
      canaryService: canary-api-service
      stableService: api-service  
      trafficRouting:
        istio:
          virtualService: 
            name: api-vs
            routes:             
              - primary
      analysis:
        templates:
        - templateName: success-rate
        startingStep: 3 # delay starting analysis run until setWeight: 20%
        args:
        - name: service-name
          value: canary-api-service.prod.svc.cluster.local
#        - name: handler
#          value: "/ping"    
#      analysis:
#        templates:
#        - templateName: success-rate-prometheus
#        startingStep: 4 # delay starting analysis run until setWeight: 50%
#        args:
#        - name: service-name
#          value: canary-api-service
#          value: canary-api-service.prod.svc.cluster.local
#        - name: handler
#          value: "/ping"    


      steps:
        - setWeight: 10
        - pause:
            duration: 10
        - setWeight: 50
        - pause: {}
        - setWeight: 60
        - pause:
            duration: 10
        - setWeight: 80
        - pause:
            duration: 10
